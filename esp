local Players = game:GetService("Players")
local Teams = game:GetService("Teams")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local pGui = player:WaitForChild("PlayerGui")

-- 1. LIMPIEZA
if pGui:FindFirstChild("MasterHub_Final") then
    pGui.MasterHub_Final:Destroy()
end

-- 2. CREACIÓN DEL HUB
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "MasterHub_Final"
screenGui.ResetOnSpawn = false  
screenGui.IgnoreGuiInset = true
screenGui.Parent = pGui

local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.Size = UDim2.new(0, 180, 0, 180)
mainFrame.Position = UDim2.new(0.5, -90, 0.4, 0)
mainFrame.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
mainFrame.BackgroundTransparency = 0.2
mainFrame.Active = true
mainFrame.Parent = screenGui

Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 15)

local layout = Instance.new("UIListLayout", mainFrame)
layout.Padding = UDim.new(0, 8)
layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
layout.VerticalAlignment = Enum.VerticalAlignment.Center
layout.SortOrder = Enum.SortOrder.LayoutOrder

-- 3. FUNCIÓN PARA CREAR BOTONES
local function createBtn(text, color, order)
    local btn = Instance.new("TextButton")
    btn.LayoutOrder = order
    btn.Size = UDim2.new(0.85, 0, 0, 35)
    btn.Font = Enum.Font.GothamBold
    btn.Text = text
    btn.TextColor3 = Color3.new(1, 1, 1)
    btn.BackgroundColor3 = color
    btn.TextSize = 13
    btn.Parent = mainFrame
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 8)
    return btn
end

local killerBtn = createBtn("Esp Killer", Color3.fromRGB(200, 50, 50), 1)
local survivorBtn = createBtn("Esp Survivor", Color3.fromRGB(50, 150, 200), 2)
local speedBtn = createBtn("Speed", Color3.fromRGB(120, 120, 120), 3)

-- 4. VARIABLES DE ESTADO
local killerActive = false
local survivorActive = false
local speedActive = false

-- 5. EVENTOS DE CLICK (CORREGIDOS)
killerBtn.MouseButton1Click:Connect(function()
    killerActive = not killerActive
    killerBtn.Text = killerActive and "Killer: On" or "Esp Killer"
    killerBtn.BackgroundColor3 = killerActive and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(200, 50, 50)
end)

survivorBtn.MouseButton1Click:Connect(function()
    survivorActive = not survivorActive
    survivorBtn.Text = survivorActive and "Survivor: On" or "Esp Survivor"
    survivorBtn.BackgroundColor3 = survivorActive and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(50, 150, 200)
end)

speedBtn.MouseButton1Click:Connect(function()
    speedActive = not speedActive
    speedBtn.Text = speedActive and "Speed: On" or "Speed"
    speedBtn.BackgroundColor3 = speedActive and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(120, 120, 120)
end)

-- 6. BUCLE DE LÓGICA (ESP Y VELOCIDAD)
RunService.RenderStepped:Connect(function()
    -- ESP
    for _, p in pairs(Players:GetPlayers()) do
        if p == player then continue end
        local char = p.Character
        if char then
            local old = char:FindFirstChild("ESPMark")
            local color = nil
            if p.Team then
                if killerActive and p.Team.Name == "Killer" then color = Color3.fromRGB(255, 0, 0)
                elseif survivorActive and p.Team.Name == "Survivor" then color = Color3.fromRGB(0, 255, 255) end
            end
            if color then
                if not old then
                    local h = Instance.new("Highlight", char)
                    h.Name = "ESPMark"
                    h.FillColor = color
                else old.FillColor = color end
            elseif old then old:Destroy() end
        end
    end
    
    -- Speed
    if player.Character and player.Character:FindFirstChild("Humanoid") then
        player.Character.Humanoid.WalkSpeed = speedActive and (16 * 1.4) or 16
    end
end)

-- 7. MOVIMIENTO (DRAG)
local dragging, dragStart, startPos
mainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true dragStart = input.Position startPos = mainFrame.Position
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        local delta = input.Position - dragStart
        mainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)
UserInputService.InputEnded:Connect(function(input) dragging = false end)

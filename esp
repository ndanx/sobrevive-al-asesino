local Players = game:GetService("Players")
local Teams = game:GetService("Teams")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local pGui = player:WaitForChild("PlayerGui", 10)

if not pGui then return end

-- 1. CREACIÓN DEL HUB (CON RESETONSPAWN = FALSE)
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "InmortalKillerHub"
screenGui.IgnoreGuiInset = true
screenGui.ResetOnSpawn = false -- <<< ESTO HACE QUE NO DESAPAREZCA AL MORIR
screenGui.Parent = pGui

local mainFrame = Instance.new("Frame")
mainFrame.Name = "Container"
mainFrame.Size = UDim2.new(0, 180, 0, 150)
mainFrame.Position = UDim2.new(0.5, -90, 0.4, 0)
mainFrame.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
mainFrame.BackgroundTransparency = 0.25
mainFrame.BorderSizePixel = 0
mainFrame.Active = true
mainFrame.Parent = screenGui

Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 15)

-- Título
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 35)
title.Text = "ESP MASTER HUB"
title.BackgroundTransparency = 1
title.Font = Enum.Font.GothamBold
title.TextColor3 = Color3.fromRGB(40, 40, 40)
title.TextSize = 13
title.Parent = mainFrame

-- Botón Killer
local killerBtn = Instance.new("TextButton")
killerBtn.Size = UDim2.new(0.85, 0, 0, 35)
killerBtn.Position = UDim2.new(0.075, 0, 0.25, 0)
killerBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
killerBtn.Text = "Esp Killer"
killerBtn.Font = Enum.Font.GothamBold
killerBtn.TextColor3 = Color3.new(1, 1, 1)
killerBtn.TextSize = 13
killerBtn.Parent = mainFrame
Instance.new("UICorner", killerBtn).CornerRadius = UDim.new(0, 8)

-- Botón Survivor
local survivorBtn = Instance.new("TextButton")
survivorBtn.Size = UDim2.new(0.85, 0, 0, 35)
survivorBtn.Position = UDim2.new(0.075, 0, 0.58, 0)
survivorBtn.BackgroundColor3 = Color3.fromRGB(50, 150, 200)
survivorBtn.Text = "Esp Survivor"
survivorBtn.Font = Enum.Font.GothamBold
survivorBtn.TextColor3 = Color3.new(1, 1, 1)
survivorBtn.TextSize = 13
survivorBtn.Parent = mainFrame
Instance.new("UICorner", survivorBtn).CornerRadius = UDim.new(0, 8)

-- 2. MOVIMIENTO (DRAG) MEJORADO
local dragging, dragInput, dragStart, startPos
mainFrame.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		dragStart = input.Position
		startPos = mainFrame.Position
	end
end)

UserInputService.InputChanged:Connect(function(input)
	if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
		local delta = input.Position - dragStart
		mainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
	end
end)

UserInputService.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		dragging = false
	end
end)

-- 3. LÓGICA ESP (OPTIMIZADA)
local killerEsp = false
local survivorEsp = false

local function handleESP()
	for _, p in pairs(Players:GetPlayers()) do
		if p == player then continue end
		
		local char = p.Character
		if char then
			local old = char:FindFirstChild("ESPMark")
			
			local shouldShow = false
			local color = Color3.new(1,1,1)
			
			if p.Team then
				if killerEsp and p.Team.Name == "Killer" then
					shouldShow = true
					color = Color3.fromRGB(255, 0, 0)
				elseif survivorEsp and p.Team.Name == "Survivor" then
					shouldShow = true
					color = Color3.fromRGB(0, 255, 255)
				end
			end
			
			if shouldShow then
				if not old then
					local highlight = Instance.new("Highlight")
					highlight.Name = "ESPMark"
					highlight.FillColor = color
					highlight.FillTransparency = 0.5
					highlight.OutlineColor = Color3.new(1, 1, 1)
					highlight.Parent = char
				else
					old.FillColor = color -- Actualizar color por si cambia de equipo
				end
			else
				if old then old:Destroy() end
			end
		end
	end
end

-- Eventos de Botones
killerBtn.MouseButton1Click:Connect(function()
	killerEsp = not killerEsp
	killerBtn.BackgroundColor3 = killerEsp and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(200, 50, 50)
	killerBtn.Text = killerEsp and "KILLER: ON" or "Esp Killer"
end)

survivorBtn.MouseButton1Click:Connect(function()
	survivorEsp = not survivorEsp
	survivorBtn.BackgroundColor3 = survivorEsp and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(50, 150, 200)
	survivorBtn.Text = survivorEsp and "SURVIVOR: ON" or "Esp Survivor"
end)

-- Bucle constante para aplicar el ESP
RunService.RenderStepped:Connect(handleESP)

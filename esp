local Players = game:GetService("Players")
local Teams = game:GetService("Teams")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local pGui = player:WaitForChild("PlayerGui")

-- 1. LIMPIEZA
if pGui:FindFirstChild("MasterHub_Final") then pGui.MasterHub_Final:Destroy() end

-- 2. HUB PRINCIPAL
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "MasterHub_Final"
screenGui.ResetOnSpawn = false
screenGui.Parent = pGui

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 180, 0, 180)
mainFrame.Position = UDim2.new(0.5, -90, 0.4, 0)
mainFrame.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
mainFrame.BackgroundTransparency = 0.2
mainFrame.Active = true
mainFrame.Parent = screenGui
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 15)

local layout = Instance.new("UIListLayout", mainFrame)
layout.Padding = UDim.new(0, 10)
layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
layout.VerticalAlignment = Enum.VerticalAlignment.Center

-- 3. BOTONES Y SUS ESTADOS (Usando BoolValues para forzar actualización)
local function createFeature(name, defaultText, offColor, onText)
	local state = Instance.new("BoolValue")
	state.Name = name .. "State"
	state.Value = false
	state.Parent = mainFrame
	
	local btn = Instance.new("TextButton")
	btn.Size = UDim2.new(0.85, 0, 0, 35)
	btn.Font = Enum.Font.GothamBold
	btn.TextSize = 13
	btn.TextColor3 = Color3.new(1, 1, 1)
	btn.Text = defaultText
	btn.BackgroundColor3 = offColor
	btn.Parent = mainFrame
	Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 8)
	
	-- Vinculamos el cambio de valor al cambio de texto/color
	state.Changed:Connect(function(val)
		btn.Text = val and onText or defaultText
		btn.BackgroundColor3 = val and Color3.fromRGB(50, 200, 50) or offColor
	end)
	
	btn.MouseButton1Down:Connect(function()
		state.Value = not state.Value
	end)
	
	return state
end

local killerState = createFeature("Killer", "Esp Killer", Color3.fromRGB(200, 50, 50), "Killer: On")
local survivorState = createFeature("Survivor", "Esp Survivor", Color3.fromRGB(50, 150, 200), "Survivor: On")
local speedState = createFeature("Speed", "Speed", Color3.fromRGB(120, 120, 120), "Speed: On")

-- 4. LÓGICA DE JUEGO (ESP Y SPEED)
RunService.RenderStepped:Connect(function()
	-- ESP
	for _, p in pairs(Players:GetPlayers()) do
		if p == player then continue end
		local char = p.Character
		if char then
			local old = char:FindFirstChild("ESPMark")
			local color = nil
			if p.Team then
				if killerState.Value and p.Team.Name == "Killer" then color = Color3.fromRGB(255,0,0)
				elseif survivorState.Value and p.Team.Name == "Survivor" then color = Color3.fromRGB(0,255,255) end
			end
			if color then
				if not old then
					local h = Instance.new("Highlight", char)
					h.Name = "ESPMark"
					h.FillColor = color
				else old.FillColor = color end
			elseif old then old:Destroy() end
		end
	end
	
	-- Speed
	if player.Character and player.Character:FindFirstChild("Humanoid") then
		player.Character.Humanoid.WalkSpeed = speedState.Value and 19.2 or 16
	end
end)

-- 5. MOVIMIENTO (DRAG)
local dragging, dragStart, startPos
mainFrame.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		dragStart = input.Position
		startPos = mainFrame.Position
	end
end)
UserInputService.InputChanged:Connect(function(input)
	if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
		local delta = input.Position - dragStart
		mainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
	end
end)
UserInputService.InputEnded:Connect(function(input) dragging = false end)
